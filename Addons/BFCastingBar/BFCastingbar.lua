 local _ local BFCBEvent = BLibrary("BEvent"); local BFCastingBar_6c391f92e72d1c9b7434bca8947c5e2c = BLibrary("BSecureHook"); BFCBEvent:Init{ name = "BFCastingBar", func = function() local BFCastingBar_1ec77ded1507d66ae96235380f042d6e = PlayerCastingBarFrame:CreateFontString("CastingBarFrameLatencyText"); BFCastingBar_1ec77ded1507d66ae96235380f042d6e:SetPoint("TOPRIGHT", PlayerCastingBarFrame, "TOPRIGHT", 0, 9) BFCastingBar_1ec77ded1507d66ae96235380f042d6e:SetFont("Fonts\\FRIZQT__.TTF", 12, "OUTLINE"); BFCBEvent.latencyText = BFCastingBar_1ec77ded1507d66ae96235380f042d6e BFCBEvent.castingBarText = PlayerCastingBarFrame.Text end, } function BFCBEvent:spell_start(unit) if unit ~= 'player' then return end local _spellName, startTime, endTime if self.channeling then _spellName, _, _, startTime, endTime = UnitChannelInfo(unit) elseif self.casting then _spellName, _, _, startTime, endTime = UnitCastingInfo(unit) end if not startTime or not endTime then return end self.startTime = startTime / 1000; self.endTime = endTime / 1000; local _, _, latencyHome, latencyWorld = GetNetStats(); self.timeDiff = latencyWorld/1000; self.spellName = _spellName or "" self.spellLength = self.endTime - self.startTime end function BFCBEvent:UNIT_SPELLCAST_START(unit) if unit ~= 'player' then return end self.channeling = nil self.casting = true BFCBEvent:spell_start(unit) end function BFCBEvent:UNIT_SPELLCAST_FAILED(unit) if unit ~= "player" then return end self.casting = nil self.channeling = nil end function BFCBEvent:UNIT_SPELLCAST_INTERRUPTED(unit) if unit ~= "player" then return end self.casting = nil self.channeling = nil end function BFCBEvent:UNIT_SPELLCAST_CHANNEL_START(unit) if unit ~= 'player' then return end self.channeling = true self.casting = nil BFCBEvent:spell_start(unit) end function BFCBEvent:OnUpdate(BFCastingBar_411b8aa6d5954c6020f0b9c9e80e847a) if BFCastingBar_411b8aa6d5954c6020f0b9c9e80e847a.value and (self.channeling or self.casting) then local BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117 = "" if self.spellName then BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117 = BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117..self.spellName end if self.startTime and self.endTime then BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117 = BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117.."("..string.onedigitfloat(BFCastingBar_411b8aa6d5954c6020f0b9c9e80e847a.value) end if self.spellLength then BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117 = BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117.."/"..string.onedigitfloat(self.spellLength)..") "; end self.castingBarText:SetText(BFCastingBar_e6955c64cf39bdb23dc86de1a9ec2117) self.castingBarText:Show() if self.timeDiff then self.latencyText:SetText("+"..string.twodigitfloat(self.timeDiff).."s") self.latencyText:Show() end end end local function BFCB_CastingBarUpdate(frame) BFCBEvent:OnUpdate(frame) end local function initValues() BFCBEvent.timeDiff = 0; BFCBEvent.startTime = 0; BFCBEvent.endTime = 0; BFCBEvent.spellLength = 0; end function BFCB_Toggle(enabled) if enabled then BFCBEvent:RegisterEvent("UNIT_SPELLCAST_START"); BFCBEvent:RegisterEvent("UNIT_SPELLCAST_INTERRUPTED"); BFCBEvent:RegisterEvent("UNIT_SPELLCAST_CHANNEL_START"); initValues(); BFCastingBar_6c391f92e72d1c9b7434bca8947c5e2c:Enable() BFCastingBar_6c391f92e72d1c9b7434bca8947c5e2c:HookScript(PlayerCastingBarFrame, "OnUpdate", BFCB_CastingBarUpdate); else BFCBEvent:UnregisterAllEvent(); BFCBEvent.latencyText:Hide() BFCastingBar_6c391f92e72d1c9b7434bca8947c5e2c:Disable(); end end string.twodigitfloat = function(BFCastingBar_f4e13e8ecf20422833dd2d694a22bf40) return string.format("%.2f",BFCastingBar_f4e13e8ecf20422833dd2d694a22bf40) end string.onedigitfloat = function(BFCastingBar_f4e13e8ecf20422833dd2d694a22bf40) return string.format("%.1f",BFCastingBar_f4e13e8ecf20422833dd2d694a22bf40) end 
